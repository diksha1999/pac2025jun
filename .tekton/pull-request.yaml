apiVersion: tekton.dev/v1beta1
kind: PipelineRun
metadata:
  name: my-app-pipeline-run
  annotations:
    # This tells PAC when to trigger
    pipelinesascode.tekton.dev/on-event: "[pull_request, push]"
    pipelinesascode.tekton.dev/on-target-branch: "[master]"
    pipelinesascode.tekton.dev/max-keep-runs: "5"
spec:
  pipelineSpec:
    params:
      - name: repo-url
        type: string
      - name: revision
        type: string
    workspaces:
      - name: source
    tasks:
      - name: fetch-repository
        taskRef:
          resolver: cluster
          params:
          - name: kind
            value: task
          - name: name
            value: git-clone
          - name: namespace
            value: openshift-pipelines
        workspaces:
          - name: output
            workspace: source
        params:
          - name: URL
            value: https://github.com/openshift/pipelines-vote-ui.git
          - name: REVISION
            value: $(params.revision)
      # DEBUG: Check workspace contents
      - name: debug-workspace
        runAfter:
          - fetch-repository
        workspaces:
          - name: source
            workspace: source
        taskSpec:
          workspaces:
            - name: source
          steps:
            - name: list-files
              image: registry.access.redhat.com/ubi8/ubi-minimal:latest
              script: |
                #!/bin/bash
                echo "=== Workspace Contents ==="
                ls -la $(workspaces.source.path)
                echo ""
                echo "=== Looking for Dockerfile ==="
                find $(workspaces.source.path) -name "Dockerfile*" -o -name "dockerfile*"
                echo ""
                echo "=== Current directory ==="
                pwd
      
      - name: build
        runAfter:
          - debug-workspace
        taskRef:
          resolver: cluster
          params:
          - name: kind
            value: task
          - name: name
            value: buildah
          - name: namespace
            value: openshift-pipelines
        workspaces:
          - name: source
            workspace: source
        params:
          - name: IMAGE
            value: "image-registry.openshift-image-registry.svc:5000/$(context.pipelineRun.namespace)/my-app:$(params.revision)"
      
      - name: deploy
        runAfter:
          - build
        taskSpec:
          steps:
            - name: deploy
              image: quay.io/openshift/origin-cli:latest
              script: |
                #!/bin/bash
                oc rollout restart deployment/my-app
  
  params:
    - name: repo-url
      value: "{{repo_url}}"
    - name: revision
      value: "{{revision}}"
  
  workspaces:
    - name: source
      volumeClaimTemplate:
        spec:
          accessModes:
            - ReadWriteOnce
          resources:
            requests:
              storage: 1Gi
